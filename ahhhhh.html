<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.5.0/build/index.js"></script>
    <title>Excel Invoice Cleaner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<h2>Upload Invoice File</h2>
<input type="file" id="fileUpload" accept=".xlsx" />
<button onclick="processFile()">Process File</button>
<button onclick="downloadWord()">Download Word</button>
    <h2 id="clientName"></h2>
    <h3 id="clinicName"></h3>
    <div id="clientAddress">
    </div>
    <table id="dataTable">
        <thead>
            <tr>
                <th>Claim Number</th>
                <th>Service Date</th>
                <th>Procedure (and Codes)</th>
                <th>Units</th>
                <th>Unit Rate</th>
                <th>Total Charge</th>
                <th>Patient Charge</th>
                <th>Total Paid</th>
                <th>Insurance Paid</th>
                <th>Patient Paid</th>
                <th>Total Adjustment</th>
                <th>Total Balance</th>
                <th>Insurance Balance</th>
                <th>Balance Owed</th>
            </tr>
        </thead>
        <tbody></tbody>
        </table>
<script>
    function styledCell(value) {
    return `<td style="color: ${value ? 'black' : 'white'}">${value ?? ''}</td>`;
}
let sortedData = [];
let clientName = "";
let balanceOwed = 0; // âœ… Define globally
let formattedAddressLines = []; // âœ… Global address storage


function processFile() {
    const file = document.getElementById('fileUpload').files[0];
    if (!file) {
        alert("Please select a file first.");
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const tableBody = document.querySelector('#dataTable tbody');
        tableBody.innerHTML = ''; // clear previous results
        balanceOwed = 0;

        // Loop through each sheet labeled "invoice [number]"
        workbook.SheetNames.forEach((sheetName, index) => {
            if (!/^invoice\s*\d+$/i.test(sheetName)) return; // only process matching sheets

            let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });

            jsonData = jsonData.map(row => row.map(cell =>
                typeof cell === 'string'
                    ? cell.replace(/[\r\n\t]+/g, ' ').trim()
                    : cell
            ));
function formatDate(date) {
    if (!date) return '';
    return date.replace(/-/g, '/'); 
}
function styledCell(value, forceBlack = false) {
    const displayValue = value ?? '';
    const isEmpty = displayValue === '';
    const color = (forceBlack || !isEmpty) ? 'black' : 'white';
    return `<td style="color: ${color}">${displayValue}</td>`;
}

function extractData(rows) {
    const tableBody = document.querySelector('#dataTable tbody');
    tableBody.innerHTML = '';
    balanceOwed = 0;

    rows.forEach((row, index) => {
        if (!row[0]) return;

        const isClaimRow = row[0].includes('CL-');
        const isServiceLineRow = row[0].includes('Service Line#');

        const fields = row[0].split(/\s{2,}/);

        const claimOrServiceLine = fields[0];
        const serviceDate = fields[1];

        // Procedure code + description
        let procedure = '';
        if (!isClaimRow || fields[2]) {
            const [code, ...descParts] = fields[2]?.split('-') || [];
            procedure = code && descParts.length
                ? `${code} - ${descParts.join('-')}`.trim()
                : '';
        }

        const units = fields[3] || '';
        const unitRate = fields[4] || '';
        const totalCharge = fields[5] || '';
        const patientCharge = fields[6] || '';
        const totalPaid = fields[7] || '';
        const insurancePaid = fields[8] || '';
        const patientPaid = fields[9] || '';
        const adjustment = fields[10] || '';
        const totalBalance = fields[11] || '';
        const insuranceBalance = fields[12] || '';
        const balanceOwedRow = fields[13] || '';

        if (balanceOwedRow) {
            balanceOwed += parseFloat(balanceOwedRow.replace('$', '').replace(',', '')) || 0;
        }

        // ðŸ§  Look ahead to next row to check for a service line
        const nextRow = rows[index + 1];
        const nextHasServiceLine = nextRow && nextRow[0]?.includes('Service Line#');

        // If claim row and NO service line follows it, treat it like a full row
        const forceBlack = isClaimRow && !nextHasServiceLine;

        tableBody.innerHTML += `
            <tr>
                ${styledCell(claimOrServiceLine, true)}
                ${styledCell(formatDate(serviceDate), true)}
                ${styledCell(procedure, forceBlack)}
                ${styledCell(units, forceBlack)}
                ${styledCell(unitRate, forceBlack)}
                ${styledCell(totalCharge, forceBlack)}
                ${styledCell(patientCharge, forceBlack)}
                ${styledCell(totalPaid, forceBlack)}
                ${styledCell(insurancePaid, forceBlack)}
                ${styledCell(patientPaid, forceBlack)}
                ${styledCell(adjustment, forceBlack)}
                ${styledCell(totalBalance, forceBlack)}
                ${styledCell(insuranceBalance, forceBlack)}
                ${styledCell(balanceOwedRow, forceBlack)}
            </tr>`;
    });
}
function downloadWord() {
    const currentDate = new Date().toLocaleDateString('en-US');
    groupedSections.forEach((section, index) => {
        const tableBody = section.rows.map(tr => {
            return new TableRow({
                children: Array.from(tr.querySelectorAll('td')).map(cell =>
                    new TableCell({
                        children: [new Paragraph({
                            children: [new TextRun({ text: cell.innerText || '', size: 18 })],
                            alignment: AlignmentType.CENTER
                        })]
                    })
                )
            });
        });

        const totalRow = new TableRow({
            children: [
                ...Array(13).fill(new TableCell({ children: [new Paragraph("")] })),
                new TableCell({
                    children: [new Paragraph({
                        children: [new TextRun({ text: "Total", bold: true, size: 18 })]
                    })],
                    shading: { fill: 'D3D3D3' }
                }),
                new TableCell({
                    children: [new Paragraph({
                        children: [new TextRun({ text: `$${section.balance.toFixed(2)}`, bold: true, size: 18 })]
                    })],
                    shading: { fill: 'D3D3D3' }
                })
            ]
        });
        doc.addSection({
            properties: {
                page: {
                    size: { orientation: PageOrientation.PORTRAIT },
                    margin: { top: 360, bottom: 360, left: 360, right: 360 }
                }
            },
            children: [
                new Paragraph({
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 },
                    children: [new TextRun({ text: `Statement Date: ${currentDate}`, bold: true, size: 22 })]
                }),
                new Table({
                    alignment: AlignmentType.CENTER,
                    width: { size: 50, type: WidthType.PERCENTAGE },
                    rows: [new TableRow({
                        children: [new TableCell({
                            children: [new Paragraph({
                                alignment: AlignmentType.CENTER,
                                children: [new TextRun({ text: `PAY THIS AMOUNT: $${section.balance.toFixed(2)}`, bold: true, size: 24 })]
                            })],
                            borders: {
                                top: { style: BorderStyle.SINGLE, size: 6 },
                                bottom: { style: BorderStyle.SINGLE, size: 6 },
                                left: { style: BorderStyle.SINGLE, size: 6 },
                                right: { style: BorderStyle.SINGLE, size: 6 }
                            }
                        })]
                    })]
                }),
                new Paragraph({ spacing: { after: 540 } }),
                .groupedSections.forEach((section, index) => {
        const tableBody = section.rows.map(tr => {
            return new TableRow({
                children: Array.from(tr.querySelectorAll('td')).map(cell =>
                    new TableCell({
                        children: [new Paragraph({
                            children: [new TextRun({ text: cell.innerText || '', size: 18 })],
                            alignment: AlignmentType.CENTER
                        })]
                    })
                )
            });
        });

        const totalRow = new TableRow({
            children: [
                ...Array(13).fill(new TableCell({ children: [new Paragraph("")] })),
                new TableCell({
                    children: [new Paragraph({
                        children: [new TextRun({ text: "Total", bold: true, size: 18 })]
                    })],
                    shading: { fill: 'D3D3D3' }
                }),
                new TableCell({
                    children: [new Paragraph({
                        children: [new TextRun({ text: `$${section.balance.toFixed(2)}`, bold: true, size: 18 })]
                    })],
                    shading: { fill: 'D3D3D3' }
                })
            ]
        });

        doc.addSection({
            properties: {
                page: {
                    size: { orientation: PageOrientation.PORTRAIT },
                    margin: { top: 360, bottom: 360, left: 360, right: 360 }
                }
            },
            children: [
                new Paragraph({
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 },
                    children: [new TextRun({ text: `Statement Date: ${currentDate}`, bold: true, size: 22 })]
                }),
                new Table({
                    alignment: AlignmentType.CENTER,
                    width: { size: 50, type: WidthType.PERCENTAGE },
                    rows: [new TableRow({
                        children: [new TableCell({
                            children: [new Paragraph({
                                alignment: AlignmentType.CENTER,
                                children: [new TextRun({ text: `PAY THIS AMOUNT: $${section.balance.toFixed(2)}`, bold: true, size: 24 })]
                            })],
                            borders: {
                                top: { style: BorderStyle.SINGLE, size: 6 },
                                bottom: { style: BorderStyle.SINGLE, size: 6 },
                                left: { style: BorderStyle.SINGLE, size: 6 },
                                right: { style: BorderStyle.SINGLE, size: 6 }
                            }
                        })]
                    })]
                }),
                new Paragraph({ spacing: { after: 540 } }),
                new Paragraph({
                    alignment: AlignmentType.LEFT,
                    indent: { left: 600 },
                    children: [new TextRun({ text: section.clientName, bold: true, size: 24 })]
                }),
                ...section.addressLines.map(line =>
                    new Paragraph({
                        alignment: AlignmentType.LEFT,
                        indent: { left: 600 },
                        children: [new TextRun({ text: line, bold: true, size: 24 })]
                    })
                ),
                new Paragraph({ spacing: { after: 540 } }),
                new Table({
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    rows: [
                        new TableRow({ children: tableHeaders }),
                        ...tableBody,
                        totalRow
                    ]
                }),
                ...(index < groupedSections.length - 1 ? [new Paragraph({ children: [new PageBreak()] })] : [])
            ]
        });
    });
            ]
        });
    });
    Packer.toBlob(doc).then(blob => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `All_Invoices_${currentDate.replace(/\//g, "-")}.docx`;
        link.click();
        URL.revokeObjectURL(url);
    });
}
</script>
</body>
</html>
